# SBML Complete Flow Analysis: Fetch ‚Üí Parse ‚Üí Convert ‚Üí Save

## Overview

This document traces the complete SBML import flow from loading an XML file through parsing, conversion, and saving as a .shy Petri net model.

## Complete Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        SBML IMPORT COMPLETE FLOW                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

USER INPUT (2 modes)
‚îú‚îÄ Mode 1: File Selection
‚îÇ  ‚îî‚îÄ Browse button ‚Üí FileChooser ‚Üí Select .sbml/.xml file
‚îÇ     ‚Üí Sets: self.current_filepath
‚îÇ
‚îî‚îÄ Mode 2: BioModels Fetch
   ‚îî‚îÄ Enter ID (e.g., BIOMD0000000001) ‚Üí Fetch button
      ‚Üí Downloads XML from biomodels.org
      ‚Üí Saves to: project/pathways/BIOMD0000000001.xml
      ‚Üí Sets: self.current_filepath

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
STAGE 1: PARSE SBML XML ‚Üí PathwayData
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìç Entry Point: _on_parse_clicked() or auto-triggered after fetch
üìÇ File: src/shypn/helpers/sbml_import_panel.py (line 814)

def _on_parse_clicked(self, button):
    filepath = self.current_filepath
    
    # Background thread
    def parse_thread():
        parsed_pathway = self.parser.parse_file(filepath)  # ‚Üê SBMLParser
        validation_result = self.validator.validate(parsed_pathway)
        GLib.idle_add(self._on_parse_complete, parsed_pathway, validation_result)

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
PARSE: SBMLParser.parse_file()
üìÇ File: src/shypn/data/pathway/sbml_parser.py (line 371)

Input:  SBML XML file (e.g., BIOMD0000000001.xml)
Process:
  1. Read XML using python-libsbml
  2. Extract model components:
     ‚Ä¢ SpeciesExtractor ‚Üí List[Species]
       - id, name, compartment, initial_concentration
     ‚Ä¢ ReactionExtractor ‚Üí List[Reaction]
       - id, name, reactants[], products[], kinetic_law
     ‚Ä¢ CompartmentExtractor ‚Üí Dict[str, str]
     ‚Ä¢ ParameterExtractor ‚Üí Dict[str, float]
  3. Build PathwayData object

Output: PathwayData
  ‚îú‚îÄ species: List[Species]
  ‚îÇ  ‚îî‚îÄ Species(id, name, compartment, initial_concentration)
  ‚îú‚îÄ reactions: List[Reaction]
  ‚îÇ  ‚îú‚îÄ reactants: [(species_id, stoichiometry), ...]
  ‚îÇ  ‚îú‚îÄ products: [(species_id, stoichiometry), ...]
  ‚îÇ  ‚îî‚îÄ kinetic_law: KineticLaw(formula, parameters)
  ‚îú‚îÄ compartments: Dict[id ‚Üí name]
  ‚îú‚îÄ parameters: Dict[name ‚Üí value]
  ‚îî‚îÄ metadata: Dict (name, notes, organism)

Example Output:
  PathwayData:
    species = [
      Species(id="glucose", name="Glucose", initial_concentration=5.0),
      Species(id="g6p", name="G6P", initial_concentration=0.0),
      ...
    ]
    reactions = [
      Reaction(
        id="hexokinase",
        name="Hexokinase",
        reactants=[("glucose", 1), ("atp", 1)],
        products=[("g6p", 1), ("adp", 1)]
      ),
      ...
    ]

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
VALIDATE: PathwayValidator.validate()
üìÇ File: src/shypn/data/pathway/pathway_validator.py

Checks:
  ‚úì All species referenced in reactions exist
  ‚úì All reactions have at least 1 reactant or product
  ‚úì Stoichiometry values are positive
  ‚úì Units are consistent

Output: ValidationResult(is_valid, errors[], warnings[])

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
RESULT: _on_parse_complete()
üìÇ File: src/shypn/helpers/sbml_import_panel.py (line 864)

Store results:
  self.parsed_pathway = parsed_pathway
  self.validation_result = validation_result

Update UI:
  ‚Ä¢ Preview shows: name, # species, # reactions
  ‚Ä¢ Status shows: "‚úì Parse complete"
  ‚Ä¢ Enable "Import to Canvas" button

If auto-continuing (BioModels flow):
  ‚Üí Auto-trigger _on_load_clicked()

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
STAGE 2: POST-PROCESS ‚Üí ProcessedPathwayData
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìç Entry Point: _on_load_clicked()
üìÇ File: src/shypn/helpers/sbml_import_panel.py (line 626)

def _on_load_clicked(self, button):
    parsed_pathway = self.parsed_pathway
    scale_factor = self.sbml_scale_spin.get_value()
    
    # Background thread
    def load_thread():
        # POST-PROCESS
        postprocessor = PathwayPostProcessor(scale_factor=scale_factor)
        processed = postprocessor.process(parsed_pathway)
        
        # CONVERT
        document_model = self.converter.convert(processed)
        
        # SAVE
        GLib.idle_add(self._on_load_and_save_complete, document_model, pathway_name)

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
POST-PROCESS: PathwayPostProcessor.process()
üìÇ File: src/shypn/data/pathway/pathway_postprocessor.py

Input:  PathwayData (no positions, no colors)
Process:
  1. LAYOUT: Assign positions to species/reactions
     ‚Ä¢ Algorithm: Force-directed or hierarchical
     ‚Ä¢ Spacing: node_spacing * scale_factor
     ‚Ä¢ Result: positions Dict[id ‚Üí (x, y)]
  
  2. COLORS: Assign colors by compartment
     ‚Ä¢ cytosol ‚Üí light blue
     ‚Ä¢ nucleus ‚Üí light green
     ‚Ä¢ Result: colors Dict[compartment ‚Üí hex_color]
  
  3. TOKEN NORMALIZATION: concentration ‚Üí tokens
     ‚Ä¢ Find min non-zero concentration
     ‚Ä¢ Divide all concentrations by min
     ‚Ä¢ Round to integers
     ‚Ä¢ Result: initial_tokens (int) for each species

Output: ProcessedPathwayData
  ‚îú‚îÄ species: List[Species] (with initial_tokens added)
  ‚îú‚îÄ reactions: List[Reaction]
  ‚îú‚îÄ positions: Dict[species_id ‚Üí (x, y)]
  ‚îú‚îÄ colors: Dict[compartment ‚Üí hex_color]
  ‚îú‚îÄ compartments: Dict
  ‚îú‚îÄ parameters: Dict
  ‚îî‚îÄ metadata: Dict

Example:
  ProcessedPathwayData:
    species[0].initial_tokens = 5  # glucose: 5.0 mM ‚Üí 5 tokens
    positions = {
      "glucose": (100.0, 200.0),
      "g6p": (300.0, 200.0),
      ...
    }
    colors = {
      "cytosol": "#E8F4F8",
      "nucleus": "#E8F8E8"
    }

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
STAGE 3: CONVERT ‚Üí DocumentModel
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìç Entry Point: PathwayConverter.convert()
üìÇ File: src/shypn/data/pathway/pathway_converter.py (line 554)

def convert(self, pathway: ProcessedPathwayData) -> DocumentModel:
    document = DocumentModel()
    
    # Convert species ‚Üí places
    species_converter = SpeciesConverter(pathway, document)
    species_to_place = species_converter.convert()
    
    # Convert reactions ‚Üí transitions
    reaction_converter = ReactionConverter(pathway, document, species_to_place)
    reaction_to_transition = reaction_converter.convert()
    
    # Convert stoichiometry ‚Üí arcs
    arc_converter = ArcConverter(pathway, document, species_to_place, reaction_to_transition)
    arcs = arc_converter.convert()
    
    return document

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SUB-STAGE 3A: Species ‚Üí Places
üìÇ File: src/shypn/data/pathway/pathway_converter.py (line 73)

class SpeciesConverter:
    def convert(self) -> Dict[str, Place]:
        species_to_place = {}
        
        for species in self.pathway.species:
            x, y = self.pathway.positions.get(species.id, (100.0, 100.0))
            
            # ‚ö†Ô∏è CRITICAL: Uses DocumentModel.create_place()
            # This method auto-assigns sequential IDs starting from _next_place_id
            place = self.document.create_place(x=x, y=y, label=species.name)
            
            # Set tokens
            place.set_tokens(species.initial_tokens)
            place.set_initial_marking(species.initial_tokens)
            
            # Store metadata
            place.metadata = {
                'species_id': species.id,
                'concentration': species.initial_concentration,
                'compartment': species.compartment
            }
            
            species_to_place[species.id] = place
        
        return species_to_place

ID Assignment:
  ‚Ä¢ DocumentModel._next_place_id starts at 1
  ‚Ä¢ First species ‚Üí Place with id="1", name="P1"
  ‚Ä¢ Second species ‚Üí Place with id="2", name="P2"
  ‚Ä¢ Etc.

Example:
  glucose (species) ‚Üí Place(id="1", name="P1", label="Glucose", tokens=5, x=100, y=200)
  g6p (species)     ‚Üí Place(id="2", name="P2", label="G6P", tokens=0, x=300, y=200)

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SUB-STAGE 3B: Reactions ‚Üí Transitions
üìÇ File: src/shypn/data/pathway/pathway_converter.py (line 177)

class ReactionConverter:
    def convert(self) -> Dict[str, Transition]:
        reaction_to_transition = {}
        
        for reaction in self.pathway.reactions:
            x, y = self.pathway.positions.get(reaction.id, (100.0, 100.0))
            
            # ‚ö†Ô∏è CRITICAL: Uses DocumentModel.create_transition()
            # Auto-assigns sequential IDs from _next_transition_id
            transition = self.document.create_transition(x=x, y=y, label=reaction.name)
            
            # Determine transition type based on kinetic law
            if reaction.kinetic_law:
                if self._is_mass_action(reaction.kinetic_law):
                    transition.type = 'continuous'
                elif self._has_rate_formula(reaction.kinetic_law):
                    transition.type = 'continuous'
                else:
                    transition.type = 'immediate'
            else:
                transition.type = 'immediate'
            
            # Store rate function if continuous
            if transition.type == 'continuous' and reaction.kinetic_law:
                transition.rate_function = reaction.kinetic_law.formula
            
            # Store metadata
            transition.metadata = {
                'reaction_id': reaction.id,
                'reversible': reaction.reversible
            }
            
            reaction_to_transition[reaction.id] = transition
        
        return reaction_to_transition

ID Assignment:
  ‚Ä¢ DocumentModel._next_transition_id starts at 1
  ‚Ä¢ First reaction ‚Üí Transition with id="1", name="T1"
  ‚Ä¢ Second reaction ‚Üí Transition with id="2", name="T2"
  ‚Ä¢ Etc.

Example:
  hexokinase (reaction) ‚Üí Transition(id="1", name="T1", label="Hexokinase", 
                                      type='continuous', rate_function="...")

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SUB-STAGE 3C: Stoichiometry ‚Üí Arcs
üìÇ File: src/shypn/data/pathway/pathway_converter.py (line 471)

class ArcConverter:
    def convert(self) -> List[Arc]:
        arcs = []
        
        for reaction in self.pathway.reactions:
            transition = self.reaction_to_transition[reaction.id]
            
            # Reactants ‚Üí Input arcs (Place ‚Üí Transition)
            for species_id, stoichiometry in reaction.reactants:
                place = self.species_to_place[species_id]
                
                # ‚ö†Ô∏è CRITICAL: Uses DocumentModel.create_arc()
                # Auto-assigns sequential IDs from _next_arc_id
                arc = self.document.create_arc(
                    source=place,
                    target=transition,
                    weight=int(stoichiometry)
                )
                arcs.append(arc)
            
            # Products ‚Üí Output arcs (Transition ‚Üí Place)
            for species_id, stoichiometry in reaction.products:
                place = self.species_to_place[species_id]
                arc = self.document.create_arc(
                    source=transition,
                    target=place,
                    weight=int(stoichiometry)
                )
                arcs.append(arc)
        
        return arcs

ID Assignment:
  ‚Ä¢ DocumentModel._next_arc_id starts at 1
  ‚Ä¢ First arc ‚Üí Arc with id="1", name="A1"
  ‚Ä¢ Second arc ‚Üí Arc with id="2", name="A2"
  ‚Ä¢ Etc.

Example:
  glucose + ATP ‚Üí G6P + ADP  (hexokinase reaction)
  
  Arcs created:
    Arc(id="1", name="A1", source=Place[glucose], target=Transition[hexokinase], weight=1)
    Arc(id="2", name="A2", source=Place[atp], target=Transition[hexokinase], weight=1)
    Arc(id="3", name="A3", source=Transition[hexokinase], target=Place[g6p], weight=1)
    Arc(id="4", name="A4", source=Transition[hexokinase], target=Place[adp], weight=1)

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
OUTPUT: DocumentModel
üìÇ Structure: src/shypn/data/canvas/document_model.py

DocumentModel:
  ‚îú‚îÄ places: List[Place]
  ‚îÇ  ‚îî‚îÄ Place(id, name, label, x, y, tokens, initial_marking, metadata)
  ‚îú‚îÄ transitions: List[Transition]
  ‚îÇ  ‚îî‚îÄ Transition(id, name, label, x, y, type, rate_function, metadata)
  ‚îú‚îÄ arcs: List[Arc]
  ‚îÇ  ‚îî‚îÄ Arc(id, name, source, target, weight)
  ‚îú‚îÄ metadata: Dict
  ‚îÇ  ‚îú‚îÄ source: "biochemical_pathway"
  ‚îÇ  ‚îú‚îÄ pathway_name: "Glycolysis"
  ‚îÇ  ‚îú‚îÄ species_count: 10
  ‚îÇ  ‚îú‚îÄ reactions_count: 10
  ‚îÇ  ‚îî‚îÄ compartments: ["cytosol", "mitochondria"]
  ‚îî‚îÄ ID Counters:
     ‚îú‚îÄ _next_place_id: 11 (after creating 10 places)
     ‚îú‚îÄ _next_transition_id: 11 (after creating 10 transitions)
     ‚îî‚îÄ _next_arc_id: 25 (after creating 24 arcs)

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
STAGE 4: SAVE FILES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìç Entry Point: _on_load_and_save_complete()
üìÇ File: src/shypn/helpers/sbml_import_panel.py (line 669)

def _on_load_and_save_complete(self, document_model, pathway_name):
    # 1. Save raw SBML file to project/pathways/
    filename = os.path.basename(self.current_filepath)
    pathways_dir = self.project.get_pathways_dir()
    dest_path = os.path.join(pathways_dir, filename)
    
    if not os.path.exists(dest_path):
        sbml_content = open(self.current_filepath, 'r').read()
        self.project.save_pathway_file(filename, sbml_content)
    
    # 2. Save .shy model file to project/models/
    base_name = os.path.splitext(filename)[0]
    model_filename = f"{base_name}.shy"
    models_dir = self.project.get_models_dir()
    model_filepath = os.path.join(models_dir, model_filename)
    
    # ‚ö†Ô∏è CRITICAL: Save DocumentModel to .shy file
    document_model.save_to_file(model_filepath)
    
    # 3. Create PathwayDocument metadata
    pathway_doc = PathwayDocument(
        source_type="sbml",
        source_id=base_name,
        source_organism=organism,
        name=pathway_name
    )
    pathway_doc.raw_file = filename
    pathway_doc.model_file = model_filename
    
    # 4. Register with project
    self.project.add_pathway(pathway_doc)
    self.project.save()

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SAVE: DocumentModel.save_to_file()
üìÇ File: src/shypn/data/canvas/document_model.py (line 475)

def save_to_file(self, filepath: str) -> None:
    data = self.to_dict()
    with open(filepath, 'w', encoding='utf-8') as f:
        json.dump(data, f, indent=2, ensure_ascii=False)

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SERIALIZE: DocumentModel.to_dict()
üìÇ File: src/shypn/data/canvas/document_model.py (line 364)

def to_dict(self) -> dict:
    """Serialize document to dictionary for JSON export."""
    return {
        "version": "2.0",
        "places": [place.to_dict() for place in self.places],
        "transitions": [transition.to_dict() for transition in self.transitions],
        "arcs": [arc.to_dict() for arc in self.arcs],
        "view_state": self.view_state
    }

Each object's to_dict() includes:
  ‚Ä¢ Place: id, name, label, x, y, tokens, initial_marking, metadata
  ‚Ä¢ Transition: id, name, label, x, y, type, rate_function, delay, priority, 
               firing_policy, metadata
  ‚Ä¢ Arc: id, name, source_id, target_id, weight, source_type, target_type

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
OUTPUT: .shy File (JSON)
üìÇ Example: workspace/projects/SBML/models/BIOMD0000000001.shy

{
  "version": "2.0",
  "places": [
    {
      "id": "1",
      "name": "P1",
      "label": "Glucose",
      "x": 100.0,
      "y": 200.0,
      "tokens": 5,
      "initial_marking": 5,
      "metadata": {
        "species_id": "glucose",
        "concentration": 5.0,
        "compartment": "cytosol"
      }
    },
    ...
  ],
  "transitions": [
    {
      "id": "1",
      "name": "T1",
      "label": "Hexokinase",
      "x": 200.0,
      "y": 200.0,
      "type": "continuous",
      "rate_function": "k1 * glucose * atp",
      "firing_policy": "random",
      "metadata": {
        "reaction_id": "hexokinase",
        "reversible": false
      }
    },
    ...
  ],
  "arcs": [
    {
      "id": "1",
      "name": "A1",
      "source_id": "1",
      "target_id": "1",
      "source_type": "place",
      "target_type": "transition",
      "weight": 1
    },
    ...
  ]
}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
STAGE 5: LOAD FROM FILE (User opens .shy file later)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìç Entry Point: DocumentModel.load_from_file()
üìÇ File: src/shypn/data/canvas/document_model.py (line 484)

def load_from_file(cls, filepath: str) -> 'DocumentModel':
    with open(filepath, 'r', encoding='utf-8') as f:
        data = json.load(f)
    return cls.from_dict(data)

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
DESERIALIZE: DocumentModel.from_dict()
üìÇ File: src/shypn/data/canvas/document_model.py (line 409)

@classmethod
def from_dict(cls, data: dict) -> 'DocumentModel':
    document = cls()
    
    # Restore places
    max_place_id = 0
    for place_data in data.get("places", []):
        place = Place.from_dict(place_data)
        document.places.append(place)
        
        # ‚ö†Ô∏è CRITICAL: Track max ID to update counter
        place_id_int = int(place.id)
        max_place_id = max(max_place_id, place_id_int)
    
    # Restore transitions
    max_transition_id = 0
    for transition_data in data.get("transitions", []):
        transition = Transition.from_dict(transition_data)
        document.transitions.append(transition)
        
        transition_id_int = int(transition.id)
        max_transition_id = max(max_transition_id, transition_id_int)
    
    # Restore arcs
    max_arc_id = 0
    for arc_data in data.get("arcs", []):
        arc = Arc.from_dict(arc_data, places_dict, transitions_dict)
        document.arcs.append(arc)
        
        arc_id_int = int(arc.id)
        max_arc_id = max(max_arc_id, arc_id_int)
    
    # ‚ö†Ô∏è CRITICAL FIX: Update ID counters to prevent duplicates
    document._next_place_id = max_place_id + 1
    document._next_transition_id = max_transition_id + 1
    document._next_arc_id = max_arc_id + 1
    
    return document

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
KEY FINDINGS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

## ID Generation Flow

### During SBML Conversion (Stage 3)

1. **DocumentModel starts with default counters:**
   ```python
   _next_place_id = 1
   _next_transition_id = 1
   _next_arc_id = 1
   ```

2. **Converters call create_* methods:**
   ```python
   # SpeciesConverter
   for species in pathway.species:
       place = document.create_place(x, y, label)  # Gets ID from counter, increments
   
   # ReactionConverter  
   for reaction in pathway.reactions:
       transition = document.create_transition(x, y, label)  # Gets ID from counter, increments
   
   # ArcConverter
   for reactant/product pair:
       arc = document.create_arc(source, target, weight)  # Gets ID from counter, increments
   ```

3. **Sequential ID assignment:**
   ```
   BIOMD0000000001 (12 species, 17 reactions):
   Places:      IDs 1-12   (counter ends at 13)
   Transitions: IDs 1-17   (counter ends at 18)
   Arcs:        IDs 1-66   (counter ends at 67)
   ```

4. **IDs saved as strings in JSON:**
   ```json
   {
     "id": "1",  ‚Üê Stored as string
     "name": "P1"
   }
   ```

### During File Load (Stage 5)

5. **IDs loaded from JSON:**
   ```python
   place = Place.from_dict(place_data)  # place.id = "1" (string)
   document.places.append(place)
   ```

6. **‚ö†Ô∏è CRITICAL FIX: Counter update:**
   ```python
   max_place_id = max([int(p.id) for p in document.places])
   document._next_place_id = max_place_id + 1
   ```
   
   Without this fix:
   - Counter stays at 1
   - Next manually created place gets ID 1 (duplicate!)
   - Simulation confuses the two places with same ID
   - Result: Phantom values in unconnected places

## Complete File Paths

```
workspace/
‚îî‚îÄ projects/
   ‚îî‚îÄ SBML/
      ‚îú‚îÄ pathways/
      ‚îÇ  ‚îî‚îÄ BIOMD0000000001.xml     ‚Üê Raw SBML file
      ‚îî‚îÄ models/
         ‚îî‚îÄ BIOMD0000000001.shy     ‚Üê Converted Petri net (JSON)
```

## Data Transformations Summary

| Stage | Input | Output | Key Operations |
|-------|-------|--------|----------------|
| Parse | SBML XML | PathwayData | Extract species, reactions, parameters |
| Post-Process | PathwayData | ProcessedPathwayData | Add positions, colors, normalize tokens |
| Convert | ProcessedPathwayData | DocumentModel | Create places, transitions, arcs with IDs |
| Save | DocumentModel | .shy JSON | Serialize all objects with IDs |
| Load | .shy JSON | DocumentModel | Deserialize objects, **update ID counters** |

## Critical Bug Fix (October 27, 2025)

**Issue:** Duplicate IDs after loading SBML models  
**Cause:** `from_dict()` didn't update `_next_*_id` counters  
**Fix:** Track max ID for each type, set counter to `max_id + 1`  
**Impact:** Prevents phantom values in manually created objects  

See: `doc/DUPLICATE_ID_BUG_FIX.md`
